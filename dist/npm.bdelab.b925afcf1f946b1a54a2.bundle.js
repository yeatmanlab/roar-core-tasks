"use strict";(self.webpackChunk_bdelab_roar_levantecore_tasks=self.webpackChunk_bdelab_roar_levantecore_tasks||[]).push([[364],{CdWr:function(t,e,i){var s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Cat=e.abilityPrior=void 0;const n=i("nbjq"),r=i("LvDl"),a=i("L9Ox"),o=s(i("YSVl"));e.abilityPrior=(0,a.normal)();class d{constructor({method:t="MLE",itemSelect:i="MFI",nStartItems:s=0,startSelect:n="middle",theta:r=0,minTheta:a=-6,maxTheta:u=6,prior:c=e.abilityPrior,randomSeed:h=null}={}){this.method=d.validateMethod(t),this.itemSelect=d.validateItemSelect(i),this.startSelect=d.validateStartSelect(n),this.minTheta=a,this.maxTheta=u,this.prior=c,this._zetas=[],this._resps=[],this._theta=r,this._nItems=0,this._seMeasurement=Number.MAX_VALUE,this.nStartItems=s,this._rng=null===h?(0,o.default)():(0,o.default)(h)}get theta(){return this._theta}get seMeasurement(){return this._seMeasurement}get nItems(){return this._resps.length}get resps(){return this._resps}get zetas(){return this._zetas}static validateMethod(t){const e=t.toLowerCase();if(!["mle","eap"].includes(e))throw new Error("The abilityEstimator you provided is not in the list of valid methods");return e}static validateItemSelect(t){const e=t.toLowerCase();if(!["mfi","random","closest"].includes(e))throw new Error("The itemSelector you provided is not in the list of valid methods");return e}static validateStartSelect(t){const e=t.toLowerCase();if(!["random","middle"].includes(e))throw new Error("The startSelect you provided is not in the list of valid methods");return e}updateAbilityEstimate(t,e,i=this.method){if(i=d.validateMethod(i),t=Array.isArray(t)?t:[t],e=Array.isArray(e)?e:[e],t.length!==e.length)throw new Error("Unmatched length between answers and item params");this._zetas.push(...t),this._resps.push(...e),"eap"===i?this._theta=this.estimateAbilityEAP():"mle"===i&&(this._theta=this.estimateAbilityMLE()),this.calculateSE()}estimateAbilityEAP(){let t=0,e=0;return this.prior.forEach((([i,s])=>{const n=this.likelihood(i);t+=i*n*s,e+=n*s})),t/e}estimateAbilityMLE(){let t=(0,n.minimize_Powell)(this.negLikelihood.bind(this),[0]).argument[0];return t>this.maxTheta?t=this.maxTheta:t<this.minTheta&&(t=this.minTheta),t}negLikelihood(t){return-this.likelihood(t[0])}likelihood(t){return this._zetas.reduce(((e,i,s)=>{const n=(0,a.itemResponseFunction)(t,i);return 1===this._resps[s]?e+Math.log(n):e+Math.log(1-n)}),1)}calculateSE(){const t=this._zetas.reduce(((t,e)=>t+(0,a.fisherInformation)(this._theta,e)),0);this._seMeasurement=1/Math.sqrt(t)}findNextItem(t,e=this.itemSelect,i=!0){let s,n=d.validateItemSelect(e);return s=i?(0,r.cloneDeep)(t):t,this.nItems<this.nStartItems&&(n=this.startSelect),"mfi"!==n&&s.sort(((t,e)=>t.difficulty-e.difficulty)),"middle"===n?this.selectorMiddle(s):"closest"===n?this.selectorClosest(s):"random"===n?this.selectorRandom(s):this.selectorMFI(s)}selectorMFI(t){const e=t.map((t=>Object.assign({fisherInformation:(0,a.fisherInformation)(this._theta,{a:1,b:t.difficulty,c:.5,d:1})},t)));return e.sort(((t,e)=>e.fisherInformation-t.fisherInformation)),e.forEach((t=>{delete t.fisherInformation})),{nextStimulus:e[0],remainingStimuli:e.slice(1).sort(((t,e)=>t.difficulty-e.difficulty))}}selectorMiddle(t){let e;e=t.length<this.nStartItems?Math.floor(t.length/2):Math.floor(t.length/2)+this.randomInteger(-Math.floor(this.nStartItems/2),Math.floor(this.nStartItems/2));const i=t[e];return t.splice(e,1),{nextStimulus:i,remainingStimuli:t}}selectorClosest(t){const e=(0,a.findClosest)(t,this._theta+.481),i=t[e];return t.splice(e,1),{nextStimulus:i,remainingStimuli:t}}selectorRandom(t){const e=Math.floor(this._rng()*t.length);return{nextStimulus:t.splice(e,1)[0],remainingStimuli:t}}randomInteger(t,e){return Math.floor(this._rng()*(e-t+1))+t}}e.Cat=d},L9Ox:function(t,e,i){var s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.findClosest=e.normal=e.fisherInformation=e.itemResponseFunction=void 0;const n=s(i("SHvc"));e.itemResponseFunction=(t,e)=>e.c+(e.d-e.c)/(1+Math.exp(-e.a*(t-e.b))),e.fisherInformation=(t,i)=>{const s=(0,e.itemResponseFunction)(t,i),n=1-s;return Math.pow(i.a,2)*(n/s)*(Math.pow(s-i.c,2)/Math.pow(1-i.c,2))},e.normal=(t=0,e=1,i=-4,s=4,n=.1)=>{const r=[];for(let o=i;o<=s;o+=n)r.push([o,(a=o,1/(Math.sqrt(2*Math.PI)*e)*Math.exp(-Math.pow(a-t,2)/(2*Math.pow(e,2))))]);var a;return r},e.findClosest=(t,e)=>{if(e<=t[0].difficulty)return 0;if(e>=t[t.length-1].difficulty)return t.length-1;const i=(0,n.default)(t,e,((t,e)=>t.difficulty-e));if(i>=0)return i;{const s=-2-i,n=-1-i;return Math.abs(t[s].difficulty-e)<Math.abs(t[n].difficulty-e)?s:n}}},YpQ9:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.fetchEmailAuthMethods=e.isUsernameAvailable=e.isEmailAvailable=e.isRoarAuthEmail=e.roarEmail=void 0;const n=i("CMMD");e.roarEmail=t=>`${t}@roar-auth.com`,e.isRoarAuthEmail=t=>"roar-auth.com"===t.split("@")[1],e.isEmailAvailable=(t,e)=>s(void 0,void 0,void 0,(function*(){return(0,n.fetchSignInMethodsForEmail)(t,e).then((t=>0===t.length))})),e.isUsernameAvailable=(t,i)=>s(void 0,void 0,void 0,(function*(){return(0,e.isEmailAvailable)(t,(0,e.roarEmail)(i))})),e.fetchEmailAuthMethods=(t,e)=>s(void 0,void 0,void 0,(function*(){return(0,n.fetchSignInMethodsForEmail)(t,e).then((t=>{const e=[];return-1!=t.indexOf(n.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD)&&e.push("password"),-1!=t.indexOf(n.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD)&&e.push("link"),e}))}))},TQn8:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))},n=this&&this.__rest||function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i};Object.defineProperty(e,"__esModule",{value:!0}),e.RoarAppkit=void 0;const r=i("CMMD"),a=i("IM/u"),o=i("5vcE"),d=i("YdXf"),u=i("Fa0i"),c=i("TvNY");e.RoarAppkit=class{constructor({firebaseProject:t,firebaseConfig:e,userInfo:i,taskInfo:s,assigningOrgs:n,assignmentId:r,runId:a}){if(!t&&!e)throw new Error("You must provide either a firebaseProjectKit or firebaseConfig");if(t&&e)throw new Error("You must provide either a firebaseProjectKit or firebaseConfig, not both");this.firebaseConfig=e,this.firebaseProject=t,this._userInfo=i,this._taskInfo=s,this._assigningOrgs=n,this._assignmentId=r,this._runId=a,this._authenticated=!1,this._initialized=!1,this._started=!1}_init(){return s(this,void 0,void 0,(function*(){this.firebaseConfig&&(this.firebaseProject=yield(0,c.initializeFirebaseProject)(this.firebaseConfig,"assessmentApp")),(0,r.onAuthStateChanged)(this.firebaseProject.auth,(t=>{this._authenticated=Boolean(t)})),this.user=new u.RoarAppUser(Object.assign(Object.assign({},this._userInfo),{db:this.firebaseProject.db})),this.task=new d.RoarTaskVariant(Object.assign(Object.assign({},this._taskInfo),{db:this.firebaseProject.db})),this.run=new o.RoarRun({user:this.user,task:this.task,assigningOrgs:this._assigningOrgs,assignmentId:this._assignmentId,runId:this._runId}),yield this.user.init(),this._initialized=!0}))}get authenticated(){return this._authenticated}updateUser(t){var{tasks:e,variants:i,assessmentPid:r}=t,a=n(t,["tasks","variants","assessmentPid"]);return s(this,void 0,void 0,(function*(){if(this._initialized||(yield this._init()),!this.authenticated)throw new Error("User must be authenticated to update their own data.");return this.user.updateUser(Object.assign({tasks:e,variants:i,assessmentPid:r},a))}))}startRun(t){return s(this,void 0,void 0,(function*(){if(this._initialized||(yield this._init()),!this.authenticated)throw new Error("User must be authenticated to start a run.");return this.run.startRun(t).then((()=>this._started=!0))}))}updateTaskParams(t){return s(this,void 0,void 0,(function*(){if(this._started){const e=this.task.variantId;return this.task.updateTaskParams(t).then((()=>(0,a.updateDoc)(this.user.userRef,{variants:(0,a.arrayRemove)(e)}))).then((()=>(0,a.updateDoc)(this.user.userRef,{variants:(0,a.arrayUnion)(this.task.variantId)}))).then((()=>(0,a.updateDoc)(this.run.runRef,{variantId:this.task.variantId})))}throw new Error("This run has not started. Use the startRun method first.")}))}finishRun(){return s(this,void 0,void 0,(function*(){if(this._started)return this.run.finishRun();throw new Error("This run has not started. Use the startRun method first.")}))}abortRun(){if(!this._started)throw new Error("This run has not started. Use the startRun method first.");this.run.abortRun()}writeTrial(t,e){return s(this,void 0,void 0,(function*(){if(this._started)return this.run.writeTrial(t,e);throw new Error("This run has not started. Use the startRun method first.")}))}}},"5vcE":function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.RoarRun=e.convertTrialToFirestore=void 0;const r=i("IM/u"),a=n(i("0XPj")),o=n(i("noZS")),d=n(i("JZM8")),u=n(i("D1y2")),c=n(i("hLX6")),h=i("TvNY");e.convertTrialToFirestore=t=>(0,h.removeUndefined)(Object.fromEntries(Object.entries(t).map((([t,i])=>i instanceof URL?[t,i.toString()]:"object"==typeof i&&null!==i?[t,(0,e.convertTrialToFirestore)(i)]:[t,i]))));const l=["assessment_stage","correct"],m=t=>null==t?null:t;e.RoarRun=class{constructor({user:t,task:e,assigningOrgs:i,assignmentId:s,runId:n}){if(this.user=t,this.task=e,this.assigningOrgs=i,this.assignmentId=s,this.runRef=n?(0,r.doc)(this.user.userRef,"runs",n):(0,r.doc)((0,r.collection)(this.user.userRef,"runs")),!this.task.taskRef)throw new Error("Task refs not set. Please use the task.setRefs method first.");this.started=!1,this.completed=!1,this.aborted=!1,this.scores={raw:{},computed:{}}}startRun(t){var e,i,n;return s(this,void 0,void 0,(function*(){if(yield this.user.checkUserExists(),this.task.variantRef||(yield this.task.toFirestore()),this.assigningOrgs){const t=yield(0,r.getDoc)(this.user.userRef);if(!t.exists())throw new Error("User does not exist");{const i=t.data(),s=(0,d.default)(i,Object.keys(this.assigningOrgs));for(const t of Object.keys(s))this.assigningOrgs[t]=(0,a.default)(null===(e=s[t])||void 0===e?void 0:e.current,this.assigningOrgs[t])}}const s=Object.assign(Object.assign({},t),{id:this.runRef.id,assignmentId:null!==(i=this.assignmentId)&&void 0!==i?i:null,assigningOrgs:null!==(n=this.assigningOrgs)&&void 0!==n?n:null,taskId:this.task.taskId,variantId:this.task.variantId,completed:!1,timeStarted:(0,r.serverTimestamp)(),timeFinished:null});yield(0,r.setDoc)(this.runRef,(0,h.removeUndefined)(s)).then((()=>(0,r.updateDoc)(this.user.userRef,{tasks:(0,r.arrayUnion)(this.task.taskId),variants:(0,r.arrayUnion)(this.task.variantId)}))).then((()=>this.user.updateFirestoreTimestamp())),this.started=!0}))}finishRun(){return s(this,void 0,void 0,(function*(){if(!this.started)throw new Error("Run has not been started yet. Use the startRun method first.");if(!this.aborted)return(0,r.updateDoc)(this.runRef,{completed:!0,timeFinished:(0,r.serverTimestamp)()}).then((()=>this.user.updateFirestoreTimestamp())).then((()=>this.completed=!0))}))}abortRun(){if(!this.started)throw new Error("Run has not been started yet. Use the startRun method first.");this.aborted=!0}writeTrial(t,i){return s(this,void 0,void 0,(function*(){if(!this.started)throw new Error("Run has not been started yet. Use the startRun method first.");if(!this.aborted){if(!l.every((e=>e in t)))throw new Error(`All ROAR trials saved to Firestore must have the following reserved keys: ${l}.The current trial is missing the following required keys: ${l.filter((e=>!(e in t)))}.`);const n=(0,r.doc)((0,r.collection)(this.runRef,"trials"));return(0,r.setDoc)(n,Object.assign(Object.assign({},(0,e.convertTrialToFirestore)(t)),{serverTimestamp:(0,r.serverTimestamp)()})).then((()=>s(this,void 0,void 0,(function*(){var e,s,n,a,d,l;if("test_response"===t.assessment_stage||"practice_response"===t.assessment_stage){const f="composite",v=t.subtask||f,g=t.assessment_stage.split("_")[0];let p={};v in this.scores.raw?(this.scores.raw[v][g]={thetaEstimate:m(t.thetaEstimate),thetaSE:m(t.thetaSE),numAttempted:((null===(e=this.scores.raw[v][g])||void 0===e?void 0:e.numAttempted)||0)+1,numCorrect:((null===(s=this.scores.raw[v][g])||void 0===s?void 0:s.numCorrect)||0)+ +Boolean(t.correct),numIncorrect:((null===(n=this.scores.raw[v][g])||void 0===n?void 0:n.numIncorrect)||0)+ +!t.correct},p={[`scores.raw.${v}.${g}.thetaEstimate`]:m(t.thetaEstimate),[`scores.raw.${v}.${g}.thetaSE`]:m(t.thetaSE),[`scores.raw.${v}.${g}.numAttempted`]:(0,r.increment)(1),[`scores.raw.${v}.${g}.numCorrect`]:t.correct?(0,r.increment)(1):void 0,[`scores.raw.${v}.${g}.numIncorrect`]:t.correct?void 0:(0,r.increment)(1)},v!==f&&(this.scores.raw[f][g]={numAttempted:((null===(a=this.scores.raw[f][g])||void 0===a?void 0:a.numAttempted)||0)+1,numCorrect:((null===(d=this.scores.raw[f][g])||void 0===d?void 0:d.numCorrect)||0)+ +Boolean(t.correct),numIncorrect:((null===(l=this.scores.raw[f][g])||void 0===l?void 0:l.numIncorrect)||0)+ +!t.correct,thetaEstimate:null,thetaSE:null},p=Object.assign(Object.assign({},p),{[`scores.raw.${f}.${g}.numAttempted`]:(0,r.increment)(1),[`scores.raw.${f}.${g}.numCorrect`]:t.correct?(0,r.increment)(1):void 0,[`scores.raw.${f}.${g}.numIncorrect`]:t.correct?void 0:(0,r.increment)(1)}))):((0,u.default)(this.scores.raw,[v,g],{thetaEstimate:m(t.thetaEstimate),thetaSE:m(t.thetaSE),numAttempted:1,numCorrect:t.correct?1:0,numIncorrect:t.correct?0:1}),p={[`scores.raw.${v}.${g}.thetaEstimate`]:m(t.thetaEstimate),[`scores.raw.${v}.${g}.thetaSE`]:m(t.thetaSE),[`scores.raw.${v}.${g}.numAttempted`]:1,[`scores.raw.${v}.${g}.numCorrect`]:t.correct?1:0,[`scores.raw.${v}.${g}.numIncorrect`]:t.correct?0:1},v!==f&&((0,u.default)(this.scores.raw,[f,g],{numAttempted:1,numCorrect:t.correct?1:0,numIncorrect:t.correct?0:1,thetaEstimate:null,thetaSE:null}),p=Object.assign(Object.assign({},p),{[`scores.raw.${f}.${g}.numAttempted`]:(0,r.increment)(1),[`scores.raw.${f}.${g}.numCorrect`]:t.correct?(0,r.increment)(1):void 0,[`scores.raw.${f}.${g}.numIncorrect`]:t.correct?void 0:(0,r.increment)(1)}))),this.scores.computed=i?yield i(this.scores.raw):(0,o.default)(this.scores.raw,(t=>{var e,i;return((null===(e=t.test)||void 0===e?void 0:e.numCorrect)||0)-((null===(i=t.test)||void 0===i?void 0:i.numIncorrect)||0)}));const y={scores:{computed:this.scores.computed}};return p=Object.assign(Object.assign({},p),c.default.dot(y)),(0,r.updateDoc)(this.runRef,(0,h.removeUndefined)(p)).catch((t=>{if(t.message.toLowerCase().includes("unsupported field value: undefined"))throw new Error("The computed or normed scores that you provided contained an undefined value. Firestore does not support storing undefined values. Please remove this value or convert it to ``null``.");throw t}))}})))).then((()=>{this.user.updateFirestoreTimestamp()}))}}))}}},YdXf:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.RoarTaskVariant=void 0;const n=i("IM/u"),r=i("TvNY");e.RoarTaskVariant=class{constructor({db:t,taskId:e,taskName:i,taskDescription:s,taskImage:r,taskURL:a,external:o,variantName:d,variantDescription:u,variantParams:c={}}){this.db=t,this.taskId=e,this.taskName=i,this.taskDescription=s,this.taskImage=r,this.taskURL=a,this.external=o,this.variantName=d,this.variantDescription=u,this.variantParams=c,this.taskRef=(0,n.doc)(this.db,"tasks",this.taskId),this.variantsCollectionRef=(0,n.collection)(this.taskRef,"variants"),this.variantId=void 0,this.variantRef=void 0,this._firestoreUpdateAllowed=!1}toFirestore(){return s(this,void 0,void 0,(function*(){const t={name:this.taskName,description:this.taskDescription,image:this.taskImage,taskURL:this.taskURL,external:this.external,lastUpdated:(0,n.serverTimestamp)()};yield(0,n.setDoc)(this.taskRef,(0,r.removeUndefined)(t),{merge:!0});const e=(0,n.query)(this.variantsCollectionRef,(0,n.where)("params","==",this.variantParams),(0,n.orderBy)("lastUpdated","desc"),(0,n.limit)(1));(yield(0,n.getDocs)(e)).forEach((t=>{this.variantId=t.id,this.variantRef=(0,n.doc)(this.variantsCollectionRef,this.variantId),(0,n.updateDoc)(this.variantRef,(0,r.removeUndefined)({description:this.variantDescription,lastUpdated:(0,n.serverTimestamp)()}))}));const i={name:this.variantName,description:this.variantDescription,taskURL:this.taskURL,external:this.external,params:this.variantParams,lastUpdated:(0,n.serverTimestamp)()};!this.variantId||this._createNewVariant?(this.variantRef=(0,n.doc)(this.variantsCollectionRef),yield(0,n.setDoc)(this.variantRef,(0,r.removeUndefined)(i)),this.variantId=this.variantRef.id):this._firestoreUpdateAllowed&&(yield(0,n.updateDoc)(this.variantRef,(0,r.removeUndefined)(i)))}))}updateTaskParams(t){return s(this,void 0,void 0,(function*(){if(void 0===this.variantRef)throw new Error("Cannot update task params before writing task to Firestore. Please call `.toFirestore()` first.");const e=(0,r.replaceValues)(this.variantParams),i=(0,r.replaceValues)(t),{keysAdded:s,merged:n}=(0,r.mergeGameParams)(e,i);this.variantParams=n,this._firestoreUpdateAllowed=!0,this._createNewVariant=s,yield this.toFirestore().then((()=>{this._firestoreUpdateAllowed=!1,this._createNewVariant=void 0}))}))}}},Fa0i:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))},n=this&&this.__rest||function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]])}return i},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.RoarAppUser=void 0;const a=i("IM/u"),o=r(i("zdiy")),d=i("ZCEQ"),u=i("TvNY");e.RoarAppUser=class{constructor({db:t,roarUid:e,assessmentUid:i,assessmentPid:s,userType:n=d.UserType.guest,userMetadata:r={}}){const o=Object.values(d.UserType);if(!o.includes(n))throw new Error(`User category must be one of ${o.join(", ")}.`);if(void 0===e&&n!==d.UserType.guest)throw new Error("All non-guest ROAR users must be created with a ROAR UID.");if(n===d.UserType.guest&&void 0!==e)throw new Error("Guest ROAR users cannot have a ROAR UID.");if(n!==d.UserType.guest&&void 0===s)throw new Error("All non-guest ROAR users must have an assessment PID on instantiation.");this.db=t,this.roarUid=e,this.assessmentPid=s,this.assessmentUid=i,this.userType=n,this.userMetadata=r,n===d.UserType.guest?this.userRef=(0,a.doc)(this.db,"guests",this.assessmentUid):this.userRef=(0,a.doc)(this.db,"users",this.roarUid)}init(){return s(this,void 0,void 0,(function*(){return(0,a.getDoc)(this.userRef).then((t=>{this.onFirestore=t.exists(),this.onFirestore?this.userData=t.data():this._setUserData()}))}))}_setUserData(){return s(this,void 0,void 0,(function*(){if(this.userType!==d.UserType.guest)throw new Error("Cannot set user data on a non-guest ROAR user.");return this.userData=(0,u.removeUndefined)(Object.assign(Object.assign({},this.userMetadata),{assessmentPid:this.assessmentPid,assessmentUid:this.assessmentUid,userType:this.userType})),(0,a.setDoc)(this.userRef,Object.assign(Object.assign({},this.userData),{created:(0,a.serverTimestamp)()})).then((()=>{this.onFirestore=!0}))}))}checkUserExists(){return s(this,void 0,void 0,(function*(){if(this.onFirestore||(yield this.init()),!this.onFirestore)throw new Error("This non-guest user is not in Firestore.")}))}updateUser(t){var{tasks:e,variants:i,assessmentPid:r}=t,c=n(t,["tasks","variants","assessmentPid"]);return s(this,void 0,void 0,(function*(){this.checkUserExists();let t={lastUpdated:(0,a.serverTimestamp)()};return e&&(t.tasks=(0,a.arrayUnion)(...e)),i&&(t.variants=(0,a.arrayUnion)(...i)),this.userType===d.UserType.guest&&(r&&(t.assessmentPid=r),t=Object.assign(Object.assign({},c),t)),this.userData=(0,o.default)(this.userData,Object.assign(Object.assign({},c),{tasks:e,variants:i,assessmentPid:r})),(0,a.updateDoc)(this.userRef,(0,u.removeUndefined)(t))}))}updateFirestoreTimestamp(){return s(this,void 0,void 0,(function*(){return this.checkUserExists(),(0,a.updateDoc)(this.userRef,{lastUpdated:(0,a.serverTimestamp)()})}))}}},icyM:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.RoarFirekit=void 0;const r=n(i("k4Da")),a=n(i("O7iK")),o=n(i("mwIZ")),d=n(i("D1y2")),u=n(i("E+oP")),c=n(i("7GkX")),h=n(i("3WF5")),l=n(i("18Zd")),m=n(i("v8eK")),f=i("CMMD"),v=i("IM/u"),g=i("aOJ/"),p=i("YpQ9"),y=i("TvNY"),b=i("ZCEQ"),_=i("TQn8"),w=i("+h4l"),O=i("Qc01"),I=i("YdXf");var k;!function(t){t.CLEVER="clever",t.CLASSLINK="classlink",t.GOOGLE="google",t.EMAIL="email",t.USERNAME="username"}(k||(k={}));const A=Object.assign(Object.assign({},f.ProviderId),{CLEVER:"oidc.clever",ROAR_ADMIN_PROJECT:"oidc.gse-roar-admin"});e.RoarFirekit=class{constructor({roarConfig:t,authPersistence:e=y.AuthPersistence.session,markRawConfig:i={},listenerUpdateCallback:s}){this.roarConfig=t,this._authPersistence=e,this._markRawConfig=i,this._initialized=!1,this._idTokens={},this.listenerUpdateCallback=null!=s?s:()=>{}}_scrubAuthProperties(){this.userData=void 0,this.roarAppUserInfo=void 0,this._adminOrgs=void 0,this._superAdmin=void 0,this.currentAssignments=void 0,this.oAuthAccessToken=void 0,this._adminClaimsListener=void 0,this._appClaimsListener=void 0,this._userDocListener=void 0,this._adminTokenListener=void 0,this._appTokenListener=void 0,this._idTokens={}}init(){return s(this,void 0,void 0,(function*(){return this.app=yield(0,y.initializeFirebaseProject)(this.roarConfig.app,"app",this._authPersistence,this._markRawConfig),this.admin=yield(0,y.initializeFirebaseProject)(this.roarConfig.admin,"admin",this._authPersistence,this._markRawConfig),this._initialized=!0,(0,f.onAuthStateChanged)(this.admin.auth,(t=>{this.admin&&(t?(this.admin.user=t,this._adminClaimsListener=this._listenToClaims(this.admin),this._adminTokenListener=this._listenToTokenChange(this.admin,"admin"),t.getIdToken().then((t=>{this._idTokens.admin=t}))):this.admin.user=void 0),this.listenerUpdateCallback()})),(0,f.onAuthStateChanged)(this.app.auth,(t=>{this.app&&(t?(this.app.user=t,this._appClaimsListener=this._listenToClaims(this.app),this._appTokenListener=this._listenToTokenChange(this.app,"app"),t.getIdToken().then((t=>{this._idTokens.app=t}))):this.app.user=void 0),this.listenerUpdateCallback()})),this}))}get initialized(){return this._initialized}_verifyInit(){if(!this._initialized)throw new Error("RoarFirekit has not been initialized. Use the `init` method.")}_isAuthenticated(){return this._verifyInit(),!(void 0===this.admin.user||void 0===this.app.user)}isAdmin(){return!!this.superAdmin||void 0!==this._adminOrgs&&!(0,u.default)((0,m.default)(...Object.values(this._adminOrgs)))}_verifyAuthentication(){if(this._verifyInit(),!this._isAuthenticated())throw new Error("User is not authenticated.")}_verifyAdmin(){if(this._verifyAuthentication(),!this.isAdmin())throw new Error("User is not an administrator.")}_listenToUserDoc(){if(this._verifyAuthentication(),this.dbRefs&&!this._userDocListener){let t;try{t=(0,v.onSnapshot)(this.dbRefs.admin.user,(()=>s(this,void 0,void 0,(function*(){yield this.getMyData(),this.listenerUpdateCallback()}))),(t=>{throw t}))}catch(t){if("permission-denied"!==t.code)throw t}return t}return this._userDocListener}_listenToClaims(t){if(this._verifyInit(),t.user){let e;try{e=(0,v.onSnapshot)((0,v.doc)(t.db,"userClaims",t.user.uid),(e=>s(this,void 0,void 0,(function*(){var i;const s=e.data();if(this._adminOrgs=null===(i=null==s?void 0:s.claims)||void 0===i?void 0:i.adminOrgs,null==s?void 0:s.lastUpdated){const e=new Date(s.lastUpdated);(!t.claimsLastUpdated||e>t.claimsLastUpdated)&&(yield(0,f.getIdToken)(t.user,!0),t.claimsLastUpdated=e)}this.listenerUpdateCallback()}))),(t=>{throw t}))}catch(t){if("permission-denied"!==t.code)throw t}return e}}_listenToTokenChange(t,e){return this._verifyInit(),!this._adminTokenListener&&"admin"===e||!this._appTokenListener&&"app"===e?(0,f.onIdTokenChanged)(t.auth,(t=>s(this,void 0,void 0,(function*(){var i;if(t){const s=yield t.getIdTokenResult(!1);"admin"===e&&(this._superAdmin=Boolean(s.claims.super_admin),s.claims.roarUid&&((null===(i=this.app)||void 0===i?void 0:i.user)&&(this._userDocListener=this._listenToUserDoc()),yield this.getMyData()),this._idTokenReceived=!0),this._idTokens[e]=s.token}this.listenerUpdateCallback()})))):"admin"===e?this._adminTokenListener:this._appTokenListener}_setUidCustomClaims(){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const t=(0,g.httpsCallable)(this.admin.functions,"setuidclaims"),e=yield t({assessmentUid:this.app.user.uid});if("ok"!==(0,o.default)(e.data,"status"))throw new Error("Failed to associate admin and assessment UIDs in the admin Firebase project.");const i=(0,g.httpsCallable)(this.app.functions,"setuidclaims"),s=yield i({adminUid:this.admin.user.uid,roarUid:this.roarUid});if("ok"!==(0,o.default)(s.data,"status"))throw new Error("Failed to associate admin and assessment UIDs in the app Firebase project.");return s}))}_syncCleverUser(t,e){return s(this,void 0,void 0,(function*(){if(e===k.CLEVER){if(void 0===t)throw new Error("No OAuth access token provided.");this._verifyAuthentication();const e=(0,g.httpsCallable)(this.admin.functions,"syncCleverUser"),i=yield e({assessmentUid:this.app.user.uid,accessToken:t});if("ok"!==(0,o.default)(i.data,"status"))throw new Error("Failed to sync Clever and ROAR data.")}}))}isUsernameAvailable(t){return s(this,void 0,void 0,(function*(){return this._verifyInit(),(0,p.isUsernameAvailable)(this.admin.auth,t)}))}isEmailAvailable(t){return s(this,void 0,void 0,(function*(){return this._verifyInit(),(0,p.isEmailAvailable)(this.admin.auth,t)}))}fetchEmailAuthMethods(t){return s(this,void 0,void 0,(function*(){return this._verifyInit(),(0,p.fetchEmailAuthMethods)(this.admin.auth,t)}))}isRoarAuthEmail(t){return this._verifyInit(),(0,p.isRoarAuthEmail)(t)}registerWithEmailAndPassword({email:t,password:e}){return s(this,void 0,void 0,(function*(){return this._verifyInit(),(0,f.createUserWithEmailAndPassword)(this.admin.auth,t,e).catch((t=>{console.log("Error creating user",t),console.log(t.code),console.log(t.message)})).then((()=>(0,f.createUserWithEmailAndPassword)(this.app.auth,t,e).then(this._setUidCustomClaims.bind(this))))}))}logInWithEmailAndPassword({email:t,password:e}){return s(this,void 0,void 0,(function*(){return this._verifyInit(),(0,f.signInWithEmailAndPassword)(this.admin.auth,t,e).then((()=>(0,f.signInWithEmailAndPassword)(this.app.auth,t,e).then(this._setUidCustomClaims.bind(this))))}))}logInWithUsernameAndPassword({username:t,password:e}){return s(this,void 0,void 0,(function*(){const i=(0,p.roarEmail)(t);return this.logInWithEmailAndPassword({email:i,password:e})}))}initiateLoginWithEmailLink({email:t,redirectUrl:e}){return s(this,void 0,void 0,(function*(){this._verifyInit();const i={url:e,handleCodeInApp:!0};return(0,f.sendSignInLinkToEmail)(this.admin.auth,t,i)}))}isSignInWithEmailLink(t){return s(this,void 0,void 0,(function*(){return this._verifyInit(),(0,f.isSignInWithEmailLink)(this.admin.auth,t)}))}signInWithEmailLink({email:t,emailLink:e}){return s(this,void 0,void 0,(function*(){return this._verifyInit(),(0,f.signInWithEmailLink)(this.admin.auth,t,e).then((t=>s(this,void 0,void 0,(function*(){const e=new f.OAuthProvider(A.ROAR_ADMIN_PROJECT),i=yield(0,f.getIdToken)(t.user);return e.credential({idToken:i})})))).then((t=>{if(t)return(0,f.signInWithCredential)(this.app.auth,t)})).then((t=>{if(t)return this._setUidCustomClaims()}))}))}signInWithPopup(t){return s(this,void 0,void 0,(function*(){this._verifyInit();const e=[k.GOOGLE,k.CLEVER];let i;if(t===k.GOOGLE)i=new f.GoogleAuthProvider;else{if(t!==k.CLEVER)throw new Error(`provider must be one of ${e.join(", ")}. Received ${t} instead.`);i=new f.OAuthProvider(A.CLEVER)}const n=["auth/cancelled-popup-request","auth/popup-closed-by-user"],r=t=>{if(!n.includes(t.code))throw t};let a;return(0,f.signInWithPopup)(this.admin.auth,i).then((e=>s(this,void 0,void 0,(function*(){if(t===k.GOOGLE){const t=f.GoogleAuthProvider.credentialFromResult(e);return a=null==t?void 0:t.accessToken,t}if(t===k.CLEVER){const t=f.OAuthProvider.credentialFromResult(e);a=null==t?void 0:t.accessToken;const i=new f.OAuthProvider(A.ROAR_ADMIN_PROJECT),s=yield(0,f.getIdToken)(e.user);return i.credential({idToken:s})}})))).catch(r).then((t=>{if(t)return(0,f.signInWithCredential)(this.app.auth,t).catch(r)})).then((t=>{if(t)return this._setUidCustomClaims()})).then((e=>{e&&this._syncCleverUser(a,t)}))}))}initiateRedirect(t){return s(this,void 0,void 0,(function*(){this._verifyInit();const e=[k.GOOGLE,k.CLEVER];let i;if(t===k.GOOGLE)i=new f.GoogleAuthProvider;else{if(t!==k.CLEVER)throw new Error(`provider must be one of ${e.join(", ")}. Received ${t} instead.`);i=new f.OAuthProvider(A.CLEVER)}return(0,f.signInWithRedirect)(this.admin.auth,i)}))}signInFromRedirectResult(t){return s(this,void 0,void 0,(function*(){let e,i;return this._verifyInit(),(0,f.getRedirectResult)(this.admin.auth).then((t=>s(this,void 0,void 0,(function*(){if(null!==t){const s=t.providerId;if(s===A.GOOGLE){const s=f.GoogleAuthProvider.credentialFromResult(t);return i=k.GOOGLE,e=null==s?void 0:s.accessToken,s}if(s===A.CLEVER){const s=f.OAuthProvider.credentialFromResult(t);i=k.CLEVER,e=null==s?void 0:s.accessToken;const n=new f.OAuthProvider(A.ROAR_ADMIN_PROJECT),r=yield(0,f.getIdToken)(t.user);return n.credential({idToken:r})}}return null})))).catch((e=>{if("auth/web-storage-unsupported"!=e.code)throw e;t()})).then((t=>t?(0,f.signInWithCredential)(this.app.auth,t):null)).then((t=>t?this._setUidCustomClaims():null)).then((t=>t?(this._syncCleverUser(e,i),{status:"ok"}):null))}))}_signOutApp(){return s(this,void 0,void 0,(function*(){this._appClaimsListener&&this._appClaimsListener(),this._userDocListener&&this._userDocListener(),this._scrubAuthProperties(),yield(0,f.signOut)(this.app.auth)}))}_signOutAdmin(){return s(this,void 0,void 0,(function*(){this._adminClaimsListener&&this._adminClaimsListener(),this._adminTokenListener&&this._adminTokenListener(),this._userDocListener&&this._userDocListener(),this._scrubAuthProperties(),yield(0,f.signOut)(this.admin.auth)}))}signOut(){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),yield this._signOutApp(),yield this._signOutAdmin()}))}get superAdmin(){return this._superAdmin}get idTokenReceived(){return this._idTokenReceived}get idTokens(){return this._idTokens}get restConfig(){return{admin:{headers:{Authorization:`Bearer ${this._idTokens.admin}`},baseURL:"https://firestore.googleapis.com/v1/projects/gse-roar-admin/databases/(default)/documents"},app:{headers:{Authorization:`Bearer ${this._idTokens.app}`},baseURL:"https://firestore.googleapis.com/v1/projects/gse-roar-assessment/databases/(default)/documents"}}}get adminOrgs(){return this._adminOrgs}get dbRefs(){var t,e;return(null===(t=this.admin)||void 0===t?void 0:t.user)&&(null===(e=this.app)||void 0===e?void 0:e.user)?{admin:{user:(0,v.doc)(this.admin.db,"users",this.roarUid),assignments:(0,v.collection)(this.admin.db,"users",this.roarUid,"assignments")},app:{user:(0,v.doc)(this.app.db,"users",this.roarUid),runs:(0,v.collection)(this.app.db,"users",this.roarUid,"runs"),tasks:(0,v.collection)(this.app.db,"tasks")}}:void 0}_getUser(t){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const e=(0,v.doc)(this.admin.db,"users",t),i=yield(0,v.getDoc)(e);if(i.exists()){const t=Object.assign({userType:b.UserType.guest},i.data()),s=yield(0,v.getDocs)((0,v.collection)(e,"externalData"));let n={};return s.forEach((t=>{n=Object.assign(Object.assign({},n),{[t.id]:t.data()})})),t.externalData=n,t}return{userType:b.UserType.guest,districts:(0,y.emptyOrg)(),schools:(0,y.emptyOrg)(),classes:(0,y.emptyOrg)(),families:(0,y.emptyOrg)(),groups:(0,y.emptyOrg)(),archived:!1}}))}getMyData(){var t,e,i,n;return s(this,void 0,void 0,(function*(){if(this._verifyInit(),this._isAuthenticated()&&this.roarUid&&(this.userData=yield this._getUser(this.roarUid),this.userData)){this.currentAssignments={assigned:(0,c.default)(null===(t=this.userData)||void 0===t?void 0:t.assignmentsAssigned),started:(0,c.default)(null===(e=this.userData)||void 0===e?void 0:e.assignmentsStarted),completed:(0,c.default)(null===(i=this.userData)||void 0===i?void 0:i.assignmentsCompleted)};const d=(0,m.default)(...Object.values(this.currentAssignments)),u=(0,a.default)(yield Promise.all((0,h.default)(d,(t=>s(this,void 0,void 0,(function*(){return this._getAssignment(t).then((e=>[t,e]))})))))),f=new Date;for(const t in this.currentAssignments){const e=t;this.currentAssignments[e]=(0,r.default)(this.currentAssignments[e],(t=>{const{dateOpened:e,dateClosed:i}=u[t];return e.toDate()<f&&i.toDate()>f}))}let v=(0,o.default)(this.userData,"assessmentPid");v||(v=(0,l.default)(null===(n=this.app.user.email)||void 0===n?void 0:n.match(/^(.+)@/),1)),this.roarAppUserInfo={db:this.app.db,roarUid:this.roarUid,assessmentUid:this.app.user.uid,assessmentPid:v,userType:this.userData.userType}}}))}listUsers(){return s(this,void 0,void 0,(function*(){throw new Error("Method not currently implemented.")}))}getLegalDoc(t){return s(this,void 0,void 0,(function*(){const e=(0,v.doc)(this.admin.db,"legal",t),i=yield(0,v.getDoc)(e);if(!i.exists())return null;{const t=i.data(),e=`https://raw.githubusercontent.com/${(0,o.default)(t,"gitHubOrg")}/${(0,o.default)(t,"gitHubRepository")}/${(0,o.default)(t,"currentCommit")}/${(0,o.default)(t,"fileName")}`;try{const i=yield fetch(e);return{text:yield i.text(),version:(0,o.default)(t,"currentCommit")}}catch(t){throw new Error("Error retrieving consent document from GitHub.")}}}))}updateConsentStatus(t,e){return s(this,void 0,void 0,(function*(){(0,v.updateDoc)(this.dbRefs.admin.user,{[`legal.${t}.${e}`]:new Date})}))}getUsers(t){return this._verifyAuthentication(),t.map((t=>this._getUser(t)))}get roarUid(){var t,e;return null===(e=null===(t=this.admin)||void 0===t?void 0:t.user)||void 0===e?void 0:e.uid}_getAdministration(t){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const e=(0,v.doc)(this.admin.db,"administrations",t),i=yield(0,v.getDoc)(e);if(i.exists())return Object.assign({id:t},i.data())}))}getAdministrations(t){return this._verifyAuthentication(),t.map((t=>this._getAdministration(t)))}_getAssignment(t){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const e=(0,v.doc)(this.dbRefs.admin.assignments,t),i=yield(0,v.getDoc)(e);if(i.exists()){const t=i.data(),e=(0,o.default)(t,"assessments",[]),n=yield Promise.all(e.map((t=>s(this,void 0,void 0,(function*(){const e=(0,v.doc)(this.dbRefs.app.tasks,t.taskId),i=yield(0,v.getDoc)(e);if(i.exists())return Object.assign(Object.assign({},t),{taskData:i.data()})})))));return Object.assign(Object.assign({},t),{assessments:n})}}))}getAssignments(t){return s(this,void 0,void 0,(function*(){return this._verifyAuthentication(),yield Promise.all((0,h.default)(t,(t=>s(this,void 0,void 0,(function*(){return yield this._getAssignment(t)})))))}))}startAssignment(t,e){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const i=(0,v.doc)(this.dbRefs.admin.assignments,t);return e?e.update(i,{started:!0}):(0,v.updateDoc)(i,{started:!0})}))}completeAssignment(t,e){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const i=(0,v.doc)(this.dbRefs.admin.assignments,t);return e?e.update(i,{completed:!0}):(0,v.updateDoc)(i,{completed:!0})}))}_updateAssignedAssessment(t,e,i,n){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const s=(0,v.doc)(this.dbRefs.admin.assignments,t),r=yield n.get(s);if(r.exists()){const t=r.data().assessments,a=t.findIndex((t=>t.taskId===e)),o=t[a],d=Object.assign(Object.assign({},o),i);return t[a]=d,n.update(s,{assessments:t})}return n}))}startAssessment(t,e){return s(this,void 0,void 0,(function*(){return this._verifyAuthentication(),yield(0,v.runTransaction)(this.admin.db,(i=>s(this,void 0,void 0,(function*(){var s;const n=(0,v.doc)(this.admin.db,"administrations",t),r=yield i.get(n);if(r.exists()){let n={};const a=r.data().assessments.find((t=>t.taskId===e));if(!a)throw new Error(`Could not find assessment with taskId ${e} in administration ${t}`);n=a.params;const o=(0,v.doc)(this.dbRefs.app.runs).id,d=(0,v.doc)(this.dbRefs.admin.assignments,t),u=yield i.get(d);if(u.exists()){const r=u.data().assessments,a=(null===(s=r.find((t=>t.taskId===e)))||void 0===s?void 0:s.allRunIds)||[];a.push(o);const d={startedOn:new Date,allRunIds:a};1===a.length&&(d.runId=o),yield this._updateAssignedAssessment(t,e,d,i),r.some((t=>Boolean(t.startedOn)))||(yield this.startAssignment(t,i)),void 0===this.roarAppUserInfo&&(yield this.getMyData());const c=u.data().assigningOrgs,h=yield(0,w.getTaskAndVariant)({db:this.app.db,taskId:e,variantParams:n});if(void 0===h.task)throw new Error(`Could not find task ${e}`);if(void 0===h.variant)throw new Error(`Could not find a variant of task ${e} with the params: ${JSON.stringify(n)}`);const l=h.task.name,m=h.task.description,f=h.variant.name,v=h.variant.description,g={db:this.app.db,taskId:e,taskName:l,taskDescription:m,variantName:f,variantDescription:v,variantParams:n};return this.selectBestRun({assignmentId:t,taskId:e}),new _.RoarAppkit({firebaseProject:this.app,userInfo:this.roarAppUserInfo,assigningOrgs:c,assignmentId:t,runId:o,taskInfo:g})}throw new Error(`Could not find assignment for user ${this.roarUid} with administration id ${t}`)}throw new Error(`Could not find administration with id ${t}`)}))))}))}completeAssessment(t,e){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),yield(0,v.runTransaction)(this.admin.db,(i=>s(this,void 0,void 0,(function*(){const s=(0,v.doc)(this.dbRefs.admin.assignments,t),n=yield i.get(s);yield this._updateAssignedAssessment(t,e,{completedOn:new Date},i),this.selectBestRun({assignmentId:t,taskId:e}),n.exists()&&n.data().assessments.every((t=>Boolean(t.completedOn)||t.taskId===e))&&this.completeAssignment(t,i)}))))}))}updateAssessmentRewardShown(t,e){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),yield(0,v.runTransaction)(this.admin.db,(i=>s(this,void 0,void 0,(function*(){this._updateAssignedAssessment(t,e,{rewardShown:!0},i)}))))}))}selectBestRun({assignmentId:t,taskId:e}){return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const i=(0,g.httpsCallable)(this.admin.functions,"selectBestRun"),s=yield i({assignmentId:t,taskId:e});if("ok"!==(0,o.default)(s.data,"status"))throw new Error("Failed to create administrator user account.");return(0,o.default)(s.data,"bestRun")}))}createAdministration({name:t,assessments:e,dateOpen:i,dateClose:n,sequential:r=!0,orgs:a=(0,y.emptyOrgList)()}){var o,d,u,c,h;return s(this,void 0,void 0,(function*(){this._verifyAuthentication();const l={name:t,createdBy:this.roarUid,groups:null!==(o=a.groups)&&void 0!==o?o:[],families:null!==(d=a.families)&&void 0!==d?d:[],classes:null!==(u=a.classes)&&void 0!==u?u:[],schools:null!==(c=a.schools)&&void 0!==c?c:[],districts:null!==(h=a.districts)&&void 0!==h?h:[],dateCreated:new Date,dateOpened:i,dateClosed:n,assessments:e,sequential:r};yield(0,v.runTransaction)(this.admin.db,(t=>s(this,void 0,void 0,(function*(){const e=(0,v.doc)((0,v.collection)(this.admin.db,"administrations"));t.set(e,l);const i=this.dbRefs.admin.user;t.update(i,{"adminData.administrationsCreated":(0,v.arrayUnion)(e.id)})}))))}))}assignAdministrationToOrgs(t,e=(0,y.emptyOrgList)()){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),this._verifyAdmin();const i=(0,v.doc)(this.admin.db,"administrations",t);yield(0,v.updateDoc)(i,{districts:(0,v.arrayUnion)(...e.districts),schools:(0,v.arrayUnion)(...e.schools),classes:(0,v.arrayUnion)(...e.classes),groups:(0,v.arrayUnion)(...e.groups),families:(0,v.arrayUnion)(...e.families)})}))}unassignAdministrationToOrgs(t,e=(0,y.emptyOrgList)()){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),this._verifyAdmin();const i=(0,v.doc)(this.admin.db,"administrations",t);yield(0,v.updateDoc)(i,{districts:(0,v.arrayRemove)(...e.districts),schools:(0,v.arrayRemove)(...e.schools),classes:(0,v.arrayRemove)(...e.classes),groups:(0,v.arrayRemove)(...e.groups),families:(0,v.arrayRemove)(...e.families)})}))}updateUserExternalData(t,e,i){return s(this,void 0,void 0,(function*(){throw new Error("Method not currently implemented.")}))}createStudentWithEmailPassword(t,e,i){return s(this,void 0,void 0,(function*(){if(this._verifyAuthentication(),this._verifyAdmin(),!(0,o.default)(i,"dob"))throw new Error("Student date of birth must be supplied.");const s={userType:b.UserType.student,studentData:{},districts:(0,y.emptyOrg)(),schools:(0,y.emptyOrg)(),classes:(0,y.emptyOrg)(),families:(0,y.emptyOrg)(),groups:(0,y.emptyOrg)(),archived:!1};if((0,o.default)(i,"pid"))(0,d.default)(s,"assessmentPid",i.pid);else{const e=(0,y.crc32String)(t),n=(0,o.default)(i,"district.abbreviation"),r=(0,o.default)(i,"school.abbreviation"),a=(0,o.default)(i,"group.abbreviation"),u=[];n&&u.push(n),r&&u.push(r),0===u.length&&a&&u.push(a),u.push(e),(0,d.default)(s,"assessmentPid",u.join("-"))}(0,d.default)(s,"email",t),(0,o.default)(i,"username")&&(0,d.default)(s,"username",i.username),(0,o.default)(i,"name")&&(0,d.default)(s,"name",i.name),(0,o.default)(i,"dob")&&(0,d.default)(s,"studentData.dob",i.dob),(0,o.default)(i,"gender")&&(0,d.default)(s,"studentData.gender",i.gender),(0,o.default)(i,"grade")&&(0,d.default)(s,"studentData.grade",i.grade),(0,o.default)(i,"state_id")&&(0,d.default)(s,"studentData.state_id",i.state_id),(0,o.default)(i,"hispanic_ethnicity")&&(0,d.default)(s,"studentData.hispanic_ethnicity",i.hispanic_ethnicity),(0,o.default)(i,"ell_status")&&(0,d.default)(s,"studentData.ell_status",i.ell_status),(0,o.default)(i,"iep_status")&&(0,d.default)(s,"studentData.iep_status",i.iep_status),(0,o.default)(i,"frl_status")&&(0,d.default)(s,"studentData.frl_status",i.frl_status),(0,o.default)(i,"race")&&(0,d.default)(s,"studentData.race",i.race),(0,o.default)(i,"home_language")&&(0,d.default)(s,"studentData.home_language",i.home_language),(0,o.default)(i,"district")&&(0,d.default)(s,"orgIds.district",i.district.id),(0,o.default)(i,"school")&&(0,d.default)(s,"orgIds.school",i.school.id),(0,o.default)(i,"class")&&(0,d.default)(s,"orgIds.class",i.class.id),(0,o.default)(i,"group")&&(0,d.default)(s,"orgIds.group",i.group.id),(0,o.default)(i,"family")&&(0,d.default)(s,"orgIds.family",i.family.id);const n=(0,g.httpsCallable)(this.admin.functions,"createstudentaccount"),r=yield n({email:t,password:e,userData:s}),a=(0,o.default)(r,"data.adminUid"),u=(0,g.httpsCallable)(this.app.functions,"createstudentaccount"),c=yield u({adminUid:a,email:t,password:e,userData:s}),h=(0,o.default)(c,"data.assessmentUid"),l=(0,g.httpsCallable)(this.admin.functions,"associateassessmentuid");yield l({adminUid:a,assessmentUid:h})}))}createStudentWithUsernamePassword(t,e,i){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),this._verifyAdmin();const s=`${t}@roar-auth.com`;return this.createStudentWithEmailPassword(s,e,i)}))}createAdministrator(t,e,i,n){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),this._verifyAdmin();const s=(0,g.httpsCallable)(this.admin.functions,"createAdministratorAccount"),r=yield s({email:t,name:e,orgs:i,adminOrgs:n});if("ok"!==(0,o.default)(r.data,"status"))throw new Error("Failed to create administrator user account.")}))}getTasks(t=!0){return s(this,void 0,void 0,(function*(){return this._verifyAuthentication(),(0,w.getTasks)(this.app.db,t)}))}getVariants(t=!0){return s(this,void 0,void 0,(function*(){return this._verifyAuthentication(),(0,w.getVariants)(this.app.db,t)}))}getMyAdministrations(t=!0){return s(this,void 0,void 0,(function*(){if(this._verifyAuthentication(),this._superAdmin||this._adminOrgs){const e=this._superAdmin?void 0:this._adminOrgs;return(0,O.getAdministrations)({db:this.admin.db,isSuperAdmin:this._superAdmin||!1,orgs:e,includeStats:t})}throw new Error("You must be an admin to get organizations.")}))}getOrgsById({orgType:t,orgIds:e,pageLimit:i=15,startAfterDocId:n}){return s(this,void 0,void 0,(function*(){return(0,w.getOrganizations)({db:this.admin.db,orgType:t,orgIds:e,pageLimit:i,startAfterDocId:n})}))}getOrgs(t){var e;return s(this,void 0,void 0,(function*(){if(this._verifyAuthentication(),this._superAdmin)return(0,w.getOrganizations)({db:this.admin.db,orgType:t});if(this._adminOrgs){const i=void 0===this._adminOrgs[t]?[]:[...this._adminOrgs[t]];if(["schools","classes"].includes(t)){const s=this._adminOrgs.districts;let n=[];if(void 0!==s){const t=yield(0,w.getOrganizations)({db:this.admin.db,orgType:"districts",orgIds:s});n=(0,m.default)(...t.map((t=>t.schools)))}if("schools"===t)i.push(...n);else if("classes"===t){const t=(0,m.default)(n,null!==(e=this._adminOrgs.schools)&&void 0!==e?e:[]),s=yield(0,w.getOrganizations)({db:this.admin.db,orgType:"schools",orgIds:t}),r=(0,m.default)(...s.map((t=>t.classes)));i.push(...r)}}return(0,w.getOrganizations)({db:this.admin.db,orgType:t,orgIds:i})}throw new Error("You must be an admin to get organizations.")}))}getUsersBySingleOrg({orgType:t,orgId:e,countOnly:i=!1}){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),this._verifyAdmin();const s=(0,y.emptyOrgList)();return s[t]=[e],(0,O.getUsersByOrgs)({db:this.admin.db,isSuperAdmin:this._superAdmin||!1,orgs:s,countOnly:i})}))}getUsersByOrgs({orgs:t,countOnly:e=!1}){return s(this,void 0,void 0,(function*(){return this._verifyAuthentication(),this._verifyAdmin(),(0,O.getUsersByOrgs)({db:this.admin.db,isSuperAdmin:this._superAdmin||!1,orgs:t,countOnly:e})}))}syncCleverOrgs(t=!1){return s(this,void 0,void 0,(function*(){if(this._verifyAuthentication(),!this._superAdmin)throw new Error("You must be a super admin to sync Clever organizations.");const e=(0,g.httpsCallable)(this.admin.functions,"syncCleverOrgs",{timeout:3e5}),i=yield e({shallow:t});if("ok"!==(0,o.default)(i.data,"status"))throw new Error("Failed to sync Clever orgs.")}))}createOrg(t,e){return s(this,void 0,void 0,(function*(){if(this._verifyAuthentication(),this._verifyAdmin(),"schools"===t&&void 0===e.districtId)throw new Error("You must specify a districtId when creating a school.");if("classes"===t&&void 0===e.schoolId)throw new Error("You must specify a schoolId when creating a class.");if("classes"===t){const t=(0,v.doc)(this.admin.db,"schools",e.schoolId),i=yield(0,v.getDoc)(t).then((t=>{if(t.exists())return t.data().districtId;throw new Error(`Could not find a school with ID ${e.schoolId} in the ROAR database.`)}));e=Object.assign(Object.assign({},e),{districtId:i})}const i=yield(0,v.addDoc)((0,v.collection)(this.admin.db,t),e).then((i=>s(this,void 0,void 0,(function*(){return yield(0,v.setDoc)((0,v.doc)(this.app.db,t,i.id),e),i.id}))));if("schools"===t){const t=e.districtId,s=(0,v.doc)(this.admin.db,"districts",t),n=(0,v.doc)(this.app.db,"districts",t);yield(0,v.updateDoc)(s,{schools:(0,v.arrayUnion)(i)}),yield(0,v.updateDoc)(n,{schools:(0,v.arrayUnion)(i)})}else if("classes"===t){const t=e.schoolId,s=(0,v.doc)(this.admin.db,"schools",t),n=(0,v.doc)(this.app.db,"schools",t);yield(0,v.updateDoc)(s,{classes:(0,v.arrayUnion)(i)}),yield(0,v.updateDoc)(n,{classes:(0,v.arrayUnion)(i)})}return i}))}getUsersByAssignment({assignmentId:t,orgs:e,countOnly:i=!1,includeScores:n=!1}){return s(this,void 0,void 0,(function*(){return this._verifyAuthentication(),this._verifyAdmin(),(0,O.getUsersByAssignment)({db:this.admin.db,assessmentDb:this.app.db,assignmentId:t,orgs:e,countOnly:i,includeScores:n})}))}registerTaskVariant({taskId:t,taskName:e,taskDescription:i,taskImage:n,taskURL:r,variantName:a,variantDescription:o,variantParams:d={}}){return s(this,void 0,void 0,(function*(){this._verifyAuthentication(),this._verifyAdmin();const s=new I.RoarTaskVariant({db:this.app.db,taskId:t,taskName:e,taskDescription:i,taskImage:n,taskURL:r,variantName:a,variantDescription:o,variantParams:d});return yield s.toFirestore(),s}))}}},ZCEQ:(t,e)=>{var i;Object.defineProperty(e,"__esModule",{value:!0}),e.UserType=void 0,(i=e.UserType||(e.UserType={})).admin="admin",i.educator="educator",i.student="student",i.caregiver="caregiver",i.guest="guest",i.researcher="researcher"},Qc01:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.getUsersByAssignment=e.getAdministrations=e.getUsersByOrgs=e.buildQueryByAssignment=e.buildQueryByOrgs=void 0;const r=i("IM/u"),a=i("TvNY"),o=n(i("TYy9")),d=n(i("v8eK")),u=n(i("qPyV")),c=i("+h4l");e.buildQueryByOrgs=({db:t,collectionName:e,nested:i,isSuperAdmin:s=!1,orgs:n})=>{var a,o,u,c,h,l,m,f,v,g;const p=(0,r.collection)(t,e);if(!n){if(s)return(0,r.query)(p);throw new Error("Orgs are required if user is not a super admin")}if((0,d.default)(...Object.values(n)).length>30)throw console.error("Too many orgs",n),new Error("Too many orgs to query. Please chunk orgs such that the total number of orgs is less than 30.");const y=[];if(i?((null===(a=n.districts)||void 0===a?void 0:a.length)&&y.push((0,r.where)("districts.current","array-contains-any",n.districts)),(null===(o=n.schools)||void 0===o?void 0:o.length)&&y.push((0,r.where)("schools.current","array-contains-any",n.schools)),(null===(u=n.classes)||void 0===u?void 0:u.length)&&y.push((0,r.where)("classes.current","array-contains-any",n.classes)),(null===(c=n.groups)||void 0===c?void 0:c.length)&&y.push((0,r.where)("groups.current","array-contains-any",n.groups)),(null===(h=n.families)||void 0===h?void 0:h.length)&&y.push((0,r.where)("families.current","array-contains-any",n.families))):((null===(l=n.districts)||void 0===l?void 0:l.length)&&y.push((0,r.where)("districts","array-contains-any",n.districts)),(null===(m=n.schools)||void 0===m?void 0:m.length)&&y.push((0,r.where)("schools","array-contains-any",n.schools)),(null===(f=n.classes)||void 0===f?void 0:f.length)&&y.push((0,r.where)("classes","array-contains-any",n.classes)),(null===(v=n.groups)||void 0===v?void 0:v.length)&&y.push((0,r.where)("groups","array-contains-any",n.groups)),(null===(g=n.families)||void 0===g?void 0:g.length)&&y.push((0,r.where)("families","array-contains-any",n.families))),0!==y.length)return(0,r.query)(p,(0,r.or)(...y))},e.buildQueryByAssignment=({db:t,assignmentId:e,orgs:i})=>{const s=(0,r.collectionGroup)(t,"assignments"),n=(0,r.where)("id","==",e);if(i){if((0,d.default)(...Object.values(i)).length>25)throw new Error("Too many orgs to query. Please chunk orgs such that the total number of orgs is less than 30.");const t=[];if(i.districts.length&&t.push((0,r.where)("assigningOrgs.districts","array-contains-any",i.districts)),i.schools.length&&t.push((0,r.where)("assigningOrgs.schools","array-contains-any",i.schools)),i.classes.length&&t.push((0,r.where)("assigningOrgs.classes","array-contains-any",i.classes)),i.groups.length&&t.push((0,r.where)("assigningOrgs.groups","array-contains-any",i.groups)),i.families.length&&t.push((0,r.where)("assigningOrgs.families","array-contains-any",i.families)),0===t.length)return;return(0,r.query)(s,(0,r.and)(n,(0,r.or)(...t)))}return(0,r.query)(s,n)};const h=({query:t,countOnly:e=!1})=>s(void 0,void 0,void 0,(function*(){if(e)return(yield(0,r.getCountFromServer)(t)).data().count;{const e=[];return(yield(0,r.getDocs)(t)).forEach((t=>{e.push(Object.assign({id:t.id},t.data()))})),e}}));e.getUsersByOrgs=({db:t,orgs:i,isSuperAdmin:n=!1,countOnly:r=!1})=>s(void 0,void 0,void 0,(function*(){const s=(0,a.chunkOrgLists)({orgs:i,chunkSize:20}),d=[];for(const i of s){const s=(0,e.buildQueryByOrgs)({db:t,collectionName:"users",nested:!0,isSuperAdmin:n,orgs:i});s&&d.push(h({query:s,countOnly:r}))}const c=yield Promise.all(d);return r?c.reduce(((t,e)=>t+e),0):(0,u.default)((0,o.default)(c),(t=>t.id))}));const l=({query:t,includeStats:e=!0})=>s(void 0,void 0,void 0,(function*(){const i=[],s=yield(0,r.getDocs)(t);for(const t of s.docs){const s=t.data();if(e){const e=(0,r.doc)(t.ref,"stats","completion"),i=yield(0,r.getDoc)(e);i.exists()&&(s.stats=i.data())}i.push(Object.assign({id:t.id},s))}return i}));e.getAdministrations=({db:t,orgs:i,isSuperAdmin:n=!1,includeStats:r=!0})=>s(void 0,void 0,void 0,(function*(){const s=(0,a.chunkOrgLists)({orgs:i,chunkSize:20}),d=[];for(const i of s){const s=(0,e.buildQueryByOrgs)({db:t,collectionName:"administrations",nested:!1,orgs:i,isSuperAdmin:n});s&&d.push(l({query:s,includeStats:r}))}const c=(0,o.default)(yield Promise.all(d));return(0,u.default)(c,(t=>t.id))}));const m=({docSnap:t,assessmentDb:e,includeScores:i=!1})=>s(void 0,void 0,void 0,(function*(){const s=t.ref.parent.parent;if(!s)return;const n=(0,r.getDoc)(s),a=t.data(),o=a.assessments,d=[];if(i){console.log("userRef",s);for(const t of o){const i=t.runId;i&&d.push((0,c.getRunById)({db:e,runId:i}).catch((t=>{if(console.log("caught error",t),!t.message.includes("Could not find run with id"))throw t})).then((e=>[t.taskId,null==e?void 0:e.scores])))}}const[u,h]=yield Promise.all([n,Promise.all(d)]);if(i){for(const[t,e]of h)if(e&&t){const i=o.findIndex((e=>e.taskId===t)),s=o[i],n=Object.assign(Object.assign({},s),{scores:e});o[i]=n}a.assessments=o}return u.exists()?{id:u.id,user:u.data(),assignment:a}:void 0})),f=({assessmentDb:t,query:e,countOnly:i=!1,includeScores:n=!1})=>s(void 0,void 0,void 0,(function*(){if(i)return(yield(0,r.getCountFromServer)(e)).data().count;{const i=[],s=yield(0,r.getDocs)(e);for(const e of s.docs)i.push(m({docSnap:e,assessmentDb:t,includeScores:n}));return yield Promise.all(i)}}));e.getUsersByAssignment=({db:t,assessmentDb:i,assignmentId:n,orgs:r,countOnly:d=!1,includeScores:c=!1})=>s(void 0,void 0,void 0,(function*(){if(c&&!i)throw new Error("You must provide an assessmentDb if you want to include scores.");const s=[];if(r){const o=(0,a.chunkOrgLists)({orgs:r,chunkSize:20});for(const r of o){const a=(0,e.buildQueryByAssignment)({db:t,assignmentId:n,orgs:r});a&&s.push(f({assessmentDb:i,query:a,countOnly:d,includeScores:c}))}}const h=yield Promise.all(s);if(d)return h.reduce(((t,e)=>t+e),0);const l=(0,o.default)(h).filter((t=>void 0!==t));return(0,u.default)(l,(t=>t.id))}))},"+h4l":function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.getRunById=e.getTaskAndVariant=e.getRunTrials=e.getUserRuns=e.formatDate=e.queryUsers=e.getVariants=e.getTasks=e.getOrganizations=void 0;const r=i("IM/u"),a=i("TvNY"),o=n(i("kcif"));e.getOrganizations=({db:t,orgType:e,orgIds:i,pageLimit:n=15,startAfterDocId:a})=>s(void 0,void 0,void 0,(function*(){let s;if(!i)return s=a?(0,r.query)((0,r.collection)(t,e),(0,r.orderBy)((0,r.documentId)()),(0,r.startAfter)(a),(0,r.limit)(n)):(0,r.query)((0,r.collection)(t,e),(0,r.orderBy)((0,r.documentId)()),(0,r.limit)(n)),(yield(0,r.getDocs)(s)).docs.map((t=>{const e=t.data();return e.id=t.id,e}));let d=i.sort();if(a){const t=d.indexOf(a)+1;d=d.slice(t,t+n)}const u=[];for(const i of(0,o.default)(d,10)){s=(0,r.query)((0,r.collection)(t,e),(0,r.where)((0,r.documentId)(),"in",i));const n=yield(0,r.getDocs)(s);u.push(...n.docs.map((t=>{const e=t.data();return e.id=t.id,e})))}return u})),e.getTasks=(t,e=!0)=>s(void 0,void 0,void 0,(function*(){let i;i=e?(0,r.query)((0,r.collection)(t,"tasks"),(0,r.where)("registered","==",!0)):(0,r.query)((0,r.collection)(t,"tasks"));const s=yield(0,r.getDocs)(i),n=[];return s.forEach((t=>{const e=t.data();n.push(Object.assign({id:t.id,image:e.image,name:e.name,description:e.description,registered:e.registered},e))})),n})),e.getVariants=(t,i=!0)=>s(void 0,void 0,void 0,(function*(){const s=[],n=yield(0,e.getTasks)(t,i);for(const e of n){let n;n=i?(0,r.query)((0,r.collection)(t,"tasks",e.id,"variants"),(0,r.where)("registered","==",!0)):(0,r.query)((0,r.collection)(t,"tasks",e.id,"variants")),(yield(0,r.getDocs)(n)).forEach((t=>{if("empty"!==t.id){const i=t.data();s.push({id:t.id,task:e,variant:Object.assign({id:t.id,name:i.name,params:i.params,registered:i.registered,lastUpdated:i.lastUpdated},i)})}}))}return s})),e.queryUsers=(t,e,i)=>s(void 0,void 0,void 0,(function*(){const s=[];if(e.length>0){let n;n=i.length>0?(0,r.query)((0,r.collection)(t,"users"),(0,r.where)("variants","array-contains-any",i)):(0,r.query)((0,r.collection)(t,"users"),(0,r.where)("tasks","array-contains-any",e)),(yield(0,r.getDocs)(n)).forEach((t=>{const{districtIds:e,schoolIds:i,groupIds:n,classIds:r}=(0,a.getOrgs)(t.data());s.push({roarUid:t.id,districts:e,schools:i,groups:n,classes:r})}))}return s})),e.formatDate=t=>null==t?void 0:t.toLocaleString("en-US"),e.getUserRuns=(t,i,n,o,d)=>s(void 0,void 0,void 0,(function*(){const s=[],{roarUid:u,districts:c,schools:h,classes:l,groups:m}=i;if([(0,a.userHasSelectedOrgs)(c,n.districts),(0,a.userHasSelectedOrgs)(h,n.schools),(0,a.userHasSelectedOrgs)(l,n.classes),(0,a.userHasSelectedOrgs)(m,n.groups)].every((t=>!0===t))){let i;i=d.length>0?(0,r.query)((0,r.collection)(t,"users",u,"runs"),(0,r.where)("variantId","in",d)):(0,r.query)((0,r.collection)(t,"users",u,"runs"),(0,r.where)("taskId","in",o)),(yield(0,r.getDocs)(i)).forEach((t=>{var i,n;const r=t.data(),a={roarUid:u,runId:t.id};a.timeStarted=(0,e.formatDate)(null===(i=r.timeStarted)||void 0===i?void 0:i.toDate())||null,a.timeFinished=(0,e.formatDate)(null===(n=r.timeFinished)||void 0===n?void 0:n.toDate())||null,a.task={id:r.taskId},a.variant={id:r.variantId},a.district={id:r.districtId},a.school={id:r.schoolId},a.class={id:r.classId},a.group={id:r.groupId},delete r.taskRef,delete r.variantRef,delete r.taskId,delete r.variantId,delete r.districtId,delete r.schoolId,delete r.classId,delete r.groupId,delete r.timeStarted,delete r.timeFinished,s.push(Object.assign(Object.assign({},a),r))}))}return s})),e.getRunTrials=(t,i)=>s(void 0,void 0,void 0,(function*(){const s=(0,r.query)((0,r.collection)(t,"users",i.roarUid,"runs",i.runId,"trials")),n=yield(0,r.getDocs)(s),a=[];n.forEach((t=>{var s,n;const r=t.data(),o={roarUid:i.roarUid,runId:i.runId};o.timeStarted=(0,e.formatDate)(null===(s=r.timeStarted)||void 0===s?void 0:s.toDate())||null,o.timeFinished=(0,e.formatDate)(null===(n=r.timeFinished)||void 0===n?void 0:n.toDate())||null,o.task={id:r.taskId},o.variant={id:r.variantId},o.district={id:r.districtId},o.school={id:r.schoolId},o.class={id:r.classId},o.group={id:r.groupId},delete r.taskId,delete r.variantId,delete r.districtId,delete r.schoolId,delete r.classId,delete r.groupId,delete r.timeStarted,delete r.timeFinished,a.push(Object.assign(Object.assign({},o),r))}))})),e.getTaskAndVariant=({db:t,taskId:e,variantParams:i})=>s(void 0,void 0,void 0,(function*(){const s=(0,r.doc)(t,"tasks",e),n=(0,r.collection)(s,"variants"),a=yield(0,r.getDoc)(s);if(a.exists()){const t=a.data(),e=(0,r.query)(n,(0,r.where)("params","==",i),(0,r.limit)(1));let s;return(yield(0,r.getDocs)(e)).forEach((t=>{s=Object.assign(Object.assign({},t.data()),{id:t.id})})),{task:t,variant:s}}return{task:void 0,variant:void 0}})),e.getRunById=({db:t,runId:e})=>s(void 0,void 0,void 0,(function*(){const i=(0,r.query)((0,r.collectionGroup)(t,"runs"),(0,r.where)("id","==",e)),s=yield(0,r.getDocs)(i);if(s.empty)throw new Error(`Could not find run with id: ${e}`);if(s.docs.length>1)throw new Error(`Found multiple runs with id: ${e}`);return s.docs[0].data()}))},TvNY:function(t,e,i){var s=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))((function(n,r){function a(t){try{d(s.next(t))}catch(t){r(t)}}function o(t){try{d(s.throw(t))}catch(t){r(t)}}function d(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}d((s=s.apply(t,e||[])).next())}))},n=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.chunkOrgLists=e.getTreeTableOrgs=e.crc32String=e.mergeGameParams=e.waitFor=e.emptyOrgList=e.emptyOrg=e.userHasSelectedOrgs=e.getOrgs=e.mergeIds=e.initializeFirebaseProject=e.AuthPersistence=e.safeInitializeApp=e.replaceValues=e.removeUndefined=e.removeNull=void 0;const r=i("Wcq6"),a=i("CMMD"),o=i("IM/u"),d=i("aOJ/"),u=n(i("kcif")),c=n(i("zqxM")),h=n(i("TYy9")),l=n(i("mwIZ")),m=n(i("E+oP")),f=n(i("Y+p1")),v=n(i("YO3V")),g=n(i("JBE3")),p=n(i("wEy/")),y=i("ITi8"),b=i("cC09");var _;e.removeNull=t=>Object.fromEntries(Object.entries(t).filter((([t,e])=>null!==e))),e.removeUndefined=t=>Object.fromEntries(Object.entries(t).filter((([t,e])=>void 0!==e))),e.replaceValues=(t,i=void 0,s=null)=>Object.fromEntries(Object.entries(t).map((([t,n])=>(0,v.default)(n)?[t,(0,e.replaceValues)(n,i,s)]:[t,n===i?s:n]))),e.safeInitializeApp=(t,e)=>{try{const i=(0,r.getApp)(e);if(!(0,f.default)(i.options,t))throw new Error(`There is an existing firebase app named ${e} with different configuration options.`);return i}catch(i){if("app/no-app"===i.code)return(0,r.initializeApp)(t,e);throw i}},function(t){t.local="local",t.session="session",t.none="none"}(_=e.AuthPersistence||(e.AuthPersistence={})),e.initializeFirebaseProject=(t,i,n=_.session,u={})=>s(void 0,void 0,void 0,(function*(){const s=(t,e)=>(0,l.default)(u,t)?(0,y.markRaw)(e):e;if(t.emulatorPorts){const e=(0,r.initializeApp)({projectId:t.projectId,apiKey:t.apiKey},i),n=t.emulatorPorts,u=s("auth",(0,a.getAuth)(e)),c=s("db",(0,o.getFirestore)(e)),h=s("functions",(0,d.getFunctions)(e));(0,o.connectFirestoreEmulator)(c,"127.0.0.1",n.db),(0,d.connectFunctionsEmulator)(h,"127.0.0.1",n.functions);const l=console.info;return console.info=()=>{},(0,a.connectAuthEmulator)(u,`http://127.0.0.1:${n.auth}`),console.info=l,{firebaseApp:e,auth:u,db:c,functions:h}}{const r=(0,e.safeInitializeApp)(t,i),u={firebaseApp:r,auth:s("auth",(0,a.getAuth)(r)),db:s("db",(0,o.getFirestore)(r)),functions:s("functions",(0,d.getFunctions)(r))};return n===_.session?yield(0,a.setPersistence)(u.auth,a.browserSessionPersistence):n===_.local?yield(0,a.setPersistence)(u.auth,a.browserLocalPersistence):n===_.none&&(yield(0,a.setPersistence)(u.auth,a.inMemoryPersistence)),u}})),e.mergeIds=(t,e)=>{const i=[];return t&&i.push(t),e&&e.length&&i.push(...e),[...new Set(i)]},e.getOrgs=t=>{const{districtId:i,schoolId:s,schools:n,classId:r,classes:a,groupId:o,groups:d}=t;return{districtIds:(0,e.mergeIds)(i,void 0),schoolIds:(0,e.mergeIds)(s,n),classIds:(0,e.mergeIds)(r,a),groupIds:(0,e.mergeIds)(o,d)}},e.userHasSelectedOrgs=(t,e)=>0===e.length||Boolean(t.filter((t=>e.includes(t))).length),e.emptyOrg=()=>({current:[],all:[],dates:{}}),e.emptyOrgList=()=>({districts:[],schools:[],classes:[],groups:[],families:[]}),e.waitFor=t=>{const e=i=>{t()?i():setTimeout((()=>e(i)),300)};return new Promise(e)},e.mergeGameParams=(t,e)=>{let i=!1;const s=(0,g.default)(Object.assign({},t),e,((t,e,s)=>{if(null===t)return e;if((0,f.default)(t,e))return e;if(void 0===t&&void 0!==e)return i=!0,e;throw new Error(`Attempted to change previously non-null value with key ${s}`)})),n=(0,c.default)(Object.keys(s),Object.keys(e));if(!(0,m.default)(n))throw new Error(`Detected deleted keys: ${n.join(", ")}`);return{keysAdded:i,merged:s}},e.crc32String=t=>{return(e=(0,b.str)(t),i=e,s=Math.pow(2,32),i-Math.floor(i/s)*s).toString(16);var e,i,s};const w=(t,e,i=0)=>t.map(((t,s)=>({key:(s+i).toString(),data:Object.assign(Object.assign({},t),{orgType:e})})));e.getTreeTableOrgs=t=>{const{districts:e=[],schools:i=[],classes:s=[],groups:n=[],families:r=[]}=t,a=w(e,"district"),o=w(i,"school"),d=w(s,"class");let u=[];if(e.length){u=a;for(const t of o){const e=t.data.districtId,i=u.findIndex((t=>t.data.id===e)),s=(0,p.default)(d,(e=>e.data.schoolId===t.data.id));if(-1!==i){const e=u[i];void 0===e.children?u[i].children=[Object.assign(Object.assign(Object.assign({},t),{key:`${e.key}-0`}),s.length>0&&{children:s.map(((t,i)=>({key:`${e.key}-0-${i}`,data:t.data})))})]:u[i].children.push(Object.assign(Object.assign(Object.assign({},t),{key:`${e.key}-${e.children.length}`}),s.length>0&&{children:s.map(((t,i)=>({key:`${e.key}-${e.children.length}-${i}`,data:t.data})))}))}else u.push(Object.assign(Object.assign(Object.assign({},t),{key:`${u.length}`}),s.length>0&&{children:s.map(((t,e)=>({key:`${u.length}-${e}`,data:t.data})))}))}for(const t of d){const e=t.data.districtId,i=u.findIndex((t=>t.data.id===e));if(-1!==i){const e=u[i];void 0===e.children?u[i].children=[{key:`${e.key}-0`,data:t.data}]:u[i].children.push({key:`${e.key}-${e.children.length}`,data:t.data})}else u.push({key:`${u.length}`,data:t.data})}}else if(i.length){u=o;for(const t of d){const e=t.data.schoolId,i=u.findIndex((t=>t.data.id===e));if(-1!==i){const e=u[i];void 0===e.children?u[i].children=[Object.assign(Object.assign({},t),{key:`${e.key}-0`})]:u[i].children.push(Object.assign(Object.assign({},t),{key:`${e.key}-${e.children.length}`}))}else u.push(Object.assign(Object.assign({},t),{key:`${u.length}`}))}}else s.length&&(u=d);const c=w(n,"group",u.length);u.push(...c);const h=w(r,"family",u.length);return u.push(...h),u},e.chunkOrgLists=({orgs:t,chunkSize:i=30})=>{if(!t)return[void 0];const s=(0,h.default)(Object.entries(t).map((([t,e])=>e.map((e=>[t,e])))));return s.length<=i?[t]:(0,u.default)(s,i).map((t=>{const i=(0,e.emptyOrgList)();for(const[e,s]of t)i[e].push(s);return i}))}},jZDP:function(t,e,i){var s=this&&this.__createBinding||(Object.create?function(t,e,i,s){void 0===s&&(s=i);var n=Object.getOwnPropertyDescriptor(e,i);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,s,n)}:function(t,e,i,s){void 0===s&&(s=i),t[s]=e[i]}),n=this&&this.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||s(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),e.initializeFirebaseProject=e.getTreeTableOrgs=e.emptyOrgList=e.emptyOrg=e.RoarTaskVariant=e.RoarAppUser=e.RoarAppkit=e.RoarFirekit=void 0;var r=i("icyM");Object.defineProperty(e,"RoarFirekit",{enumerable:!0,get:function(){return r.RoarFirekit}});var a=i("TQn8");Object.defineProperty(e,"RoarAppkit",{enumerable:!0,get:function(){return a.RoarAppkit}});var o=i("Fa0i");Object.defineProperty(e,"RoarAppUser",{enumerable:!0,get:function(){return o.RoarAppUser}});var d=i("YdXf");Object.defineProperty(e,"RoarTaskVariant",{enumerable:!0,get:function(){return d.RoarTaskVariant}});var u=i("TvNY");Object.defineProperty(e,"emptyOrg",{enumerable:!0,get:function(){return u.emptyOrg}}),Object.defineProperty(e,"emptyOrgList",{enumerable:!0,get:function(){return u.emptyOrgList}}),Object.defineProperty(e,"getTreeTableOrgs",{enumerable:!0,get:function(){return u.getTreeTableOrgs}}),Object.defineProperty(e,"initializeFirebaseProject",{enumerable:!0,get:function(){return u.initializeFirebaseProject}}),n(i("Qc01"),e),n(i("+h4l"),e)},Dp8Y:(t,e,i)=>{i.d(e,{PT:()=>n,Pf:()=>r}),i("33yf"),i("zB2q");var s=i("wOav");function n(t){return t.replace(/^([A-Z])|[\s-_](\w)/g,(function(t,e,i,s){return i?i.toUpperCase():e.toLowerCase()}))}function r(){return"touchOnly"===s.RX||"hybrid"===s.RX&&"touch"===s.DG?"mobile":"desktop"}i("CWHl")}}]);
//# sourceMappingURL=npm.bdelab.b925afcf1f946b1a54a2.bundle.js.map